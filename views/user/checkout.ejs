<!DOCTYPE html>
<html>
   <head>
      <!-- Basic -->
      <meta charset="utf-8" />
      <meta http-equiv="X-UA-Compatible" content="IE=edge" />
      <!-- Mobile Metas -->
      <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
      <!-- Site Metas -->
      <meta name="keywords" content="" />
      <meta name="description" content="" />
      <meta name="author" content="" />
      <link rel="shortcut icon" href="/user/images/favicon.png" type="">
      <title>Famms - Fashion HTML Template</title>
      <!-- bootstrap core css -->
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
      <link rel="stylesheet" type="text/css" href="/user/css/bootstrap.css" />
      <!-- font awesome style -->
      <link href="/user/css/font-awesome.min.css" rel="stylesheet" />
      <!-- Custom styles for this template -->
      <link href="/user/css/style.css" rel="stylesheet" />
      <!-- responsive style -->
      <link href="/user/css/responsive.css" rel="stylesheet" />
      
   
   

      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
      <script src="https://kit.fontawesome.com/9139d48468.js" crossorigin="anonymous"></script>
      <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" />
      <script src="https://kit.fontawesome.com/bdf5ca2238.js" crossorigin="anonymous"></script>
      
   
   
   
   
   
   
   
    </head>
   <body style="background-color: #6E6E6E;">
      <div class="hero_area">
         <!-- header section strats -->
         <%-include('./partials/navbar.ejs')%>



        <div class="checkout-container">
            <form method="post" action="/checkoutform" id="checkoutForm">
                <h1>Checkout</h1>
            
                <div class="addresses-section">
                    <h3>Select Delivery Address</h3>
                    <select class="form-control" id="address" name="address">
                        <option>select the address</option>
                        <% address.forEach((item)=>{ %>
                            <option value="<%= item._id %>">
                                <h5><%= item.address %></h5>
                                <p><%= item.city %>, <%= item.state %> <%= item.zipCode %><br>
                                <%= item.country %><br>
                                <%= item.phone %></p>
                            </option>
                        <% }) %>
                    </select>
                    
                    <button type="button" class="btn btn-primary font-weight-bold custom-btn add-address-button light-orange-btn" data-toggle="modal" data-target="#addAddressModal" style="width: 100%;">Add Address</button>
                </div>
            
                <div class="cart-details-section">
                    <h3>Your Cart</h3>
                    <table id="cart-table">
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Product</th>
                                <th>Description</th>
                                <th>Quantity</th>
                                <th>Price</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% var totalprice = 0; %>
                            <% currentCart.forEach((item,id)=>{ %>
                                <tr>
                                    <td>
                                        <img src="<%= item.image %>" alt="" class="img-fluid" />
                                    </td>
                                    <td class="checkoutproduct"><%= item.product %></td>
                                    <td class="checkoutdescription"><%= item.description %></td>
                                    <td class="checkoutquantity"><%= item.quantity %></td>
                                    <td>
                                        <% var totalpriceofeachProduct = item.price * item.quantity; %>
                                        <span class="checkoutPrice">₹<%= totalpriceofeachProduct %></span>
                                    </td>
                                    <% totalprice = totalprice + totalpriceofeachProduct %>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                    <script>

                        // address
                        document.getElementById('address').addEventListener('change', function() {
                        const selectedIndex = this.value; // Get the selected index
                        console.log("Selected index:", selectedIndex);

                        // If you need to get the selected option's text, you can do so like this:
                        const selectedOption = this.options[this.selectedIndex];
                        const selectedText = selectedOption.innerText.trim();
                        console.log("Selected text:", selectedText);
                        });
                        // end address

                        //product
                        const products = document.querySelectorAll('.checkoutproduct');
                        const descriptions = document.querySelectorAll('.checkoutdescription');
                        const quantities = document.querySelectorAll('.checkoutquantity');
                        const prices = document.querySelectorAll('.checkoutPrice');

                        products.forEach((product, index) => {
                            const productName = product.innerText.trim();
                            const description = descriptions[index].innerText.trim();
                            const quantity = quantities[index].innerText.trim();
                            const price = prices[index].innerText.trim();

                            console.log("Product:", productName);
                            console.log("Description:", description);
                            console.log("Quantity:", quantity);
                            console.log("Price:", price);
                          });



                    </script>
                </div>
            
                <div class="order-summary-section">
                    <h3>Order Summary</h3>
                    <h1>Total: ₹<span id="totalPrice"><%= totalprice %></span></h1>
                    <p>Discount: <span id="discountAmount">0%</span></p>
                </div>
            
                <div class="section">
                    <h4>Payment Options</h4>
                    <div class="form-group">
                        <label>Select Payment Method:</label>
                        <div class="form-check">
                            <input type="radio" class="form-check-input" id="cashOnDelivery" name="paymentMethod" value="Cash On Delivery">
                            <label class="form-check-label" for="cashOnDelivery">Cash On Delivery</label>
                        </div>
                        <div class="form-check">
                            <input type="radio" class="form-check-input" id="wallet" name="paymentMethod" value="wallet">
                            <label class="form-check-label" for="wallet">Wallet Payment</label><br>
                            <span class="errorMessageforwallet" style="color: red;"></span>
                        </div>
                        <div class="form-check">
                            <input type="radio" class="form-check-input" id="razorPay" name="paymentMethod" value="Razor Pay">
                            <label class="form-check-label" for="razorPay">Razor Pay</label>
                        </div>
                    </div>
                </div>
                
            
                <!-- Coupon Section -->
                <div class="section">
                    <h4>Apply Coupon</h4>
                    <div class="form-group">
                        <label for="coupon">Select Coupon:</label>
                        <select class="form-control" id="coupon" name="coupon">
                            <option value="" selected disabled>Select a Coupon</option>
                            <%couponData.forEach((items,id)=>{%>
                            <option id="coupon" value="<%= items.couponCode %>" name="coupon">
                                <%= items.couponCode %>
                            </option>
                            <%})%>
                        </select>
                        <span id="couponerrorMessage" style="color: #FF8C00;"></span>
                    </div>
                </div>
                <div id="couponsData" data-coupons=""></div>
            
                <button class="btn" type="button" onclick="applyCoupon()" id="applyCouponBtn">Apply Coupon</button>
            
                <button class="btn btn-primary"  id="checkoutBtn">Proceed to Checkout</button>
            </form>

            <script>
                function applyCoupon(){
                    const coupon=document.getElementById('coupon').value;
                    console.log("coupon",coupon);
                    fetch('/checkingCoupon', {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ couponCode: coupon })
            })
            .then(response => response.json())
            .then(data => {
                if(data.discount){
                const totalPriceElement = document.getElementById('totalPrice');
                const totalPrice = parseFloat(totalPriceElement.innerText); 
                const discountedPrice = totalPrice * (1 - data.discount/100);
                totalPriceElement.innerText = discountedPrice.toFixed(2);
                const discountAmountElement = document.getElementById('discountAmount');
                 discountAmountElement.innerText = data.discount+"%";
                 const errorElement = document.getElementById('couponerrorMessage');
                errorElement.innerHTML = " ";
                }
                else if(data.error){
                    const errorElement = document.getElementById('couponerrorMessage');
                errorElement.innerHTML = data.error;


                }
               
            })
            .catch(error => {
                console.error('There was a problem with your fetch operation:', error);
                // Handle errors, e.g., displaying an error message to the user
            });
                }

            </script>
          <script>
            document.addEventListener("DOMContentLoaded", function() {
    var checkoutBtn = document.getElementById("checkoutBtn");
    checkoutBtn.addEventListener("click", function(event) {
        event.preventDefault();

        var selectedPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
        if (!selectedPaymentMethod) {
            console.error("No payment method selected");
            return; // Exit if no payment method is selected
        }

        if(selectedPaymentMethod.value === "Cash On Delivery") {
           
            const totalPrice = parseFloat(document.getElementById('totalPrice').innerHTML);
            console.log("Total price:", totalPrice);

            if(totalPrice>=1500){
               
                Swal.fire({
            icon: 'warning',
            title: 'Cash On Delivery Alert',
            text: 'Cash on delivery is only applicable for orders below  ₹ 1500.',
            showConfirmButton: true
        });

            }else{
                var checkoutForm = document.getElementById("checkoutForm");
                console.log("else", totalPrice);
                checkoutForm.submit();
            }

           
        } else if (selectedPaymentMethod.value === "Razor Pay") {
            const address = document.getElementById('address').value;
            console.log("Selected address:", address);
            const totalPrice = parseFloat(document.getElementById('totalPrice').innerHTML);
            console.log("Total price:", totalPrice);
            const coupon=document.getElementById('coupon').value;

            // Fetch Razorpay instance
            fetch("/RazorpayInstance", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ amount: totalPrice })
            })
            .then(response => response.json())
            .then(data => {
                openRazorpay(data.orderId, totalPrice, address); // Pass totalPrice and address to openRazorpay
            })
            .catch(error => {
                console.error('There was a problem with your fetch operation:', error);
                // Handle errors, e.g., displaying an error message to the user
            });
        }
        else if (selectedPaymentMethod.value === "wallet") {
    const totalPrice = parseFloat(document.getElementById('totalPrice').innerHTML);
   
    fetch("/walletPayment", {
        method: "POST",
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ amount: totalPrice })
    })
    .then(response => {
        if (response.ok) {
           
            console.log("Payment successful");
            var checkoutFom = document.getElementById("checkoutForm");
             return checkoutFom.submit();
        } else {
           
            console.log("Payment failed");
            return response.json(); 
        }
    })
    .then(data => {
      
        if (data && data.error) {
            const error = document.getElementsByClassName('errorMessageforwallet')[0];
        error.innerHTML = data.error;
           
        }
    })
    .catch(error => {
       
        console.error("Unexpected error:", error);
        
    });
}

    });

    // Define openRazorpay outside event listener
    function openRazorpay(orderId, totalPrice, address) {
        var res={orderId,totalPrice,address};
        var options = {
            key: 'rzp_test_xxIa2EJbQL3tW2',
            amount: totalPrice * 100, // Convert to paisa
            currency: 'INR',
            name: 'The Defender',
            description: 'Purchase Description',
            order_id: orderId,
            handler: function(response) {
               
                // Handle Razorpay response
                console.log('Razorpay response:', response); // Log response to console for debugging
                if(response){
                    window.location.href = '/successpage';
                }
                // If needed, you can make another fetch call here to submit the payment details
                fetch('/checkoutform', {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        paymentId: response.razorpay_payment_id,
                        orderId: response.razorpay_order_id,
                        signature: response.razorpay_signature,
                        amount: totalPrice,
                        address: address,
                        paymentMethod: "Razor Pay" // Assuming this is the correct payment method name
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Checkout form response:', data); // Log response from checkout form endpoint
                    // Redirect to success page after successful payment
                    window.location.href = '/successpage';
                })
                .catch(error => {
                    console.error('failed payment', error);
                    window.location.href = '/home';
                });
                 }, modal: {
                          ondismiss: function() {
                       console.log("response",res);
                      fetch('/failedcheckoutform', {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        orderId: res.razorpay_order_id,
                        amount: totalPrice,
                        address: address,
                        paymentMethod: "Razor Pay" // Assuming this is the correct payment method name
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Failed checkout form response:', data); // Log response from the server
                    // Redirect to home page after handling the failed checkout
                    window.location.href = '/userOrder/:page';
                })
                .catch(error => {
                    console.error('Failed payment:', error);
                    // Optionally handle the error by redirecting to an error page or showing a message
                });

                }
            }

                    
            // Rest of the options...
        };

        var rzp = new Razorpay(options);
        rzp.open();
    }
});



          </script>
            
        </div>


<!-- modal 1 add address -->
<div class="modal fade" id="addAddressModal" tabindex="-1" role="dialog" aria-labelledby="addAddressModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addAddressModalLabel">Add Address</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <!-- Form for adding address -->
          <form action="/checkaddAddress" method="POST">


            <p  id="errorMessage" style="color: red;"></p>
                        

                                   

            <label for="user-name">userName:</label>
            <input type="text" id="userName" name="userName" required>


            <label for="address">Address:</label>
            <textarea id="address" name="address" rows="4" cols="20" required></textarea>

            <label for="city">City:</label>
            <input type="text" id="city" name="city" required>

            <label for="state">State:</label>
            <input type="text" id="state" name="state" required>

            <label for="zipcode">Zip Code:</label>
            <input type="text" id="zipcode" name="zipcode" required>

            <label for="phone">Phone:</label>
            <input type="text" id="phone" name="phone" required>


            <label for="country">Country:</label>
            <input type="text" id="country" name="country" required>

            
            <input type="submit"   value="submit">
                     
  
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/js/mdb.min.js"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
            crossorigin="anonymous"
        ></script>

        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/js/mdb.min.js"></script>
        
        <script>
            function displayAlert(message, timeout = null) {
                var alertDiv = document.createElement("div");
                alertDiv.classList.add("alert-message");
                alertDiv.textContent = message;
                var closeButton = document.createElement("span");
                closeButton.classList.add("close-button");
                closeButton.innerHTML = "&times;"; 
                alertDiv.appendChild(closeButton);
                document.body.appendChild(alertDiv);

                closeButton.addEventListener("click", function () {
                    alertDiv.parentNode.removeChild(alertDiv);
                });
                if (timeout !== null) {
                    setTimeout(function () {
                        alertDiv.parentNode.removeChild(alertDiv);
                    }, timeout);
                }
            }
        </script>

        <!-- order ,payment,coupon discount -->
       

        <!-- Razorpay SDK -->
        <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
       
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


<style>
    /* Overall Layout */
    body {
        font-family: sans-serif;
        margin-top: -10px;
        background-color: #6E6E6E;
        
        
       
    }

    .checkout-container {
        width: 1000px;
        margin: 30px auto;
        padding: 30px;
        border: 1px solid #ddd;
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.8);
    }

    h1,
    h2,
    h3 {
        margin: 10px 0;
    }

    /* Addresses Section */
    .addresses-section {
        border-bottom: 1px solid #ddd;
        padding-bottom: 20px;
        margin-bottom: 20px;
    }

    #address {
        width: 100%;
        padding: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 5px;
    }

    .add-address-button {
        display: block;
        width: 100%;
        padding: 10px 20px;
        background-color:#6E6E6E;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-bottom: 20px;
    }

    /* Cart Details Section */
    .cart-details-section {
        border-bottom: 1px solid #ddd;
        padding-bottom: 20px;
        margin-bottom: 20px;
    }

    #cart-table {
        border-collapse: collapse;
        width: 100%;
    }

    #cart-table th,
    #cart-table td {
        padding: 10px;
        border: 1px solid #ddd;
    }

    /* Order Summary Section */
    .order-summary-section {
        border-bottom: 1px solid #ddd;
        padding-bottom: 20px;
        margin-bottom: 20px;
    }

    /* Payment Options Section */
    .payment-options-section {
        border-bottom: 1px solid #ddd;
        padding-bottom: 20px;
        margin-bottom: 20px;
    }

    .payment-options-section ul {
        list-style: none;
        padding: 0;
    }

    .payment-options-section ul li {
        margin-bottom: 10px;
    }

    .payment-options-section label {
        display: inline-block;
        vertical-align: middle;
        margin-left: 10px;
    }

    .payment-option-icon {
        font-size: 24px;
        margin-right: 10px;
    }

    /* Buttons */
    button {
        background-color: #4caf50;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    /* Error messages (optional) */
    .error {
        color: red;
        font-weight: bold;
    }

    /* Adjust image size */
    .img-fluid {
        max-width: 90px;
        max-height: 96px;
        width: auto;
        height: auto;
        border-radius: 4px;
    }

    body {
        font-family: Arial, sans-serif;
        background-color: #6E6E6E;
    }
    @import url("https://fonts.googleapis.com/css?family=Roboto:400,500,700");
    * {
        -webkit-box-sizing: border-box;
        box-sizing: border-box;
    }
    body {
        padding-top: 6px; /* Adjust based on the height of your navbar */
        font-family: "Poppins", sans-serif;

        background-color: #f5f5f5;
        /* display: flex; */
    }

    .section-padding {
        padding: 100px 0;
    }

    .back-button {
        position: absolute;
        top: 25px;
        left: 80px;
        z-index: 1000; /* Ensure the button is above other elements */
    }

    .back-button a {
        font-size: 24px; /* Increase the font size of the icon */
        padding: 10px; /* Add some padding around the icon */
        color: #000; /* Adjust the color as needed */
        text-decoration: none;
    }

    .back-button a:hover {
        color: #333; /* Change the color on hover */
    }
    .header {
        position: relative;
        width: 100%;
        height: 60px; /* Adjust the height as needed */
        background-color: #f8f9fa; /* Background color of the header */
    }

    .header-text {
        position: absolute;
        top: 70%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
    }
    .header-text h1 {
        font-size: 3rem;
    }
    .header {
        margin-bottom: 20px; /* Adjust the value as needed */
    }
    .back-button {
        margin-bottom: 20px; /* Adjust the value as needed */
    }
    .alert-message {
        background-color: #0e100f;
        color: white;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
        position: fixed;
        top: 50px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 9999;
        width: 400px;
        text-align: center;
        opacity: 0;
        animation: fadeIn 0.5s ease forwards;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    .close-button {
        position: absolute;
        top: 10px;
        right: 10px;
        cursor: pointer;
        color: white;
        font-weight: bold;
        font-size: 20px;
    }
    .btn {
background-color: black;
color: white;
border: none; 
padding: 5px 10px; 
margin-right: 10px; 
cursor: pointer; 
transition: background-color 0.3s; 
}

.btn:hover {
background-color: #464545; 
color: #ffffff;
}
.btn:last-child {
margin-right: 0;
}
.add-address-button {
    background-color: #FFA500; 
    transition: background-color 0.3s ease, box-shadow 0.3s ease; 
}

.add-address-button:hover {
    background-color: #FF8C00; 
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); 
}
</style>




<%-include('./partials/footer.ejs')%>
         <!-- footer end -->
    
         <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
         </div>
      </body>
    </html>